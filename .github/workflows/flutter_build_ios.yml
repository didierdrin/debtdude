name: Build iOS for Appetize.io
on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter 3.38.6
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.6'  # Updated to match your error suggestion
        
    - name: Disable Analytics (to skip the welcome message)
      run: flutter config --no-analytics
      
    - name: Get Dependencies First
      run: |
        echo "ðŸ“¦ Getting Flutter dependencies..."
        flutter pub get
        
    - name: Generate iOS Files
      run: |
        echo "ðŸ” Checking iOS configuration..."
        
        # Check if Podfile exists
        if [ ! -f "ios/Podfile" ]; then
          echo "ðŸ“± No Podfile found. Generating iOS files..."
          
          # Create iOS platform files WITHOUT recreating entire project
          flutter create --platforms=ios --no-overwrite .
          
          echo "âœ… iOS files generated"
        else
          echo "âœ… Podfile already exists"
        fi
        
        # Verify
        echo "ðŸ“ iOS directory contents:"
        ls -la ios/
        
    - name: Install CocoaPods Dependencies
      run: |
        cd ios
        pod install --repo-update
        
    - name: Build for iOS Simulator
      run: |
        flutter build ios --simulator --debug --no-codesign
        
    - name: Create Appetize.io Package
      run: |
        if [ -d "build/ios/iphonesimulator/Runner.app" ]; then
          cd build/ios/iphonesimulator
          zip -r Runner.app.zip Runner.app
          echo "âœ… Created Runner.app.zip"
          echo "ðŸ“Š Size: $(du -h Runner.app.zip | cut -f1)"
        else
          echo "âŒ Runner.app not found!"
          echo "Searching for .app files:"
          find . -name "*.app" -type d 2>/dev/null
          exit 1
        fi
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: debtdude-ios-appetize
        path: build/ios/iphonesimulator/Runner.app.zip
        retention-days: 7
